---
import { getLangFromUrl, useTranslations } from '../i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const base = '/fordima-academy';

const languages = [
  { 
    code: 'en', 
    label: 'English', 
    emoji: 'ðŸ‡¬ðŸ‡§',
    flag: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 480" width="20" height="15"><path fill="#012169" d="M0 0h640v480H0z"/><path fill="#FFF" d="m75 0 244 181L562 0h78v62L400 241l240 178v61h-80L320 301 81 480H0v-60l239-178L0 64V0h75z"/><path fill="#C8102E" d="m424 281 216 159v40L369 281h55zM227 194 11 31l-11 4v40l227 119zM162 281l-162 120v40l197-145h-35zm256-187L640 21v40L443 181h-25z"/><path fill="#FFF" d="M241 0v480h160V0H241zM0 160v160h640V160H0z"/><path fill="#C8102E" d="M281 0v480h80V0h-80zM0 201v80h640v-80H0z"/></svg>` 
  },
  { 
    code: 'fr', 
    label: 'FranÃ§ais', 
    emoji: 'ðŸ‡«ðŸ‡·',
    flag: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 480" width="20" height="15"><g fill-rule="evenodd" stroke-width="1pt"><path fill="#fff" d="M0 0h640v480H0z"/><path fill="#002395" d="M0 0h213.3v480H0z"/><path fill="#ed2939" d="M426.7 0H640v480H426.7z"/></g></svg>` 
  },
  { 
    code: 'es', 
    label: 'EspaÃ±ol', 
    emoji: 'ðŸ‡ªðŸ‡¸',
    flag: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 480" width="20" height="15"><path fill="#c60b1e" d="M0 0h640v120H0zm0 360h640v120H0z"/><path fill="#ffc400" d="M0 120h640v240H0z"/></svg>` 
  },
  { 
    code: 'ar', 
    label: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', 
    emoji: 'ðŸ‡¸ðŸ‡¦',
    flag: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 480" width="20" height="15"><path fill="#fff" d="M0 0h640v480H0z"/><path fill="#000" d="M0 320h640v160H0z"/><path fill="#ce1126" d="M0 0h640v160H0z"/><path fill="#007a3d" d="M0 160h640v160H0z"/></svg>` 
  }
];

const currentLangData = languages.find(l => l.code === lang) || languages[0];
---

<nav class="premium-nav">
  <div class="menu-overlay" id="menu-overlay"></div>

  <div class="k-container nav-wrapper">
    <a href={`${base}/${lang}/`} class="brand-container">
      <div class="logo-box">
        <img src={`${base}/logo-fordima.png`} alt="Logo" class="logo-img" />
      </div>
      <span class="brand-text">
        FORDIMA <span class="k-text-primary">ACADEMY</span>
      </span>
    </a>

    <div class="nav-actions">
      <ul class="nav-menu-desktop">
        <li><a href={`${base}/${lang}/docs/`} class="nav-link">{t('nav.docs')}</a></li>
        <li><a href="#books" class="nav-link">{t('nav.books')}</a></li>
      </ul>

      <div class="divider desktop-only"></div>

      <div class="lang-wrapper desktop-only">
        <div class="current-flag-icon" set:html={currentLangData.flag} />
        <select onchange="window.location.pathname = this.value" class="premium-lang-select">
          {languages.map((l) => (
            <option value={`${base}/${l.code}/`} selected={lang === l.code}>
              {l.emoji} {l.label}
            </option>
          ))}
        </select>
      </div>

      <a href="https://github.com/fomadev" class="github-btn" target="_blank">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg>
        <span class="github-text">{t('nav.github')}</span>
      </a>

      <button class="burger-btn" aria-label="Open Menu" id="burger-trigger">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </button>
    </div>
  </div>

  <aside class="mobile-sidebar" id="mobile-sidebar">
    <div class="sidebar-header">
      <span class="sidebar-title">Menu</span>
      <button class="close-sidebar" id="close-sidebar">&times;</button>
    </div>

    <nav class="sidebar-nav">
      <a href={`${base}/${lang}/docs/`} class="sidebar-link">{t('nav.docs')}</a>
      <a href="#books" class="sidebar-link">{t('nav.books')}</a>
      
      <div class="sidebar-divider"></div>
      
      <p class="sidebar-label">Language</p>
      <div class="lang-wrapper sidebar-lang">
        <div class="current-flag-icon" set:html={currentLangData.flag} />
        <select onchange="window.location.pathname = this.value" class="premium-lang-select">
          {languages.map((l) => (
            <option value={`${base}/${l.code}/`} selected={lang === l.code}>
               {l.emoji} {l.label}
            </option>
          ))}
        </select>
      </div>
    </nav>
  </aside>
</nav>

<style>
  /* --- BASE --- */
  .premium-nav {
    position: sticky;
    top: 0;
    z-index: 1000;
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(12px) saturate(180%);
    border-bottom: 1px solid rgba(226, 232, 240, 0.7);
    padding: 0.75rem 0;
  }

  .nav-wrapper { display: flex; align-items: center; justify-content: space-between; }
  .brand-container { display: flex; align-items: center; gap: 12px; text-decoration: none; }
  .logo-box { background: #fff; padding: 4px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
  .logo-img { height: 40px; width: auto; }
  .brand-text { font-weight: 800; font-size: 1.1rem; color: #0f172a; }
  .nav-actions { display: flex; align-items: center; gap: 1rem; }

  /* --- DESKTOP NAV --- */
  .nav-menu-desktop { list-style: none; display: flex; gap: 1.5rem; margin: 0; padding: 0; }
  .nav-link { color: #64748b; text-decoration: none; font-weight: 600; font-size: 0.95rem; transition: color 0.3s; }
  .nav-link:hover { color: #2563eb; }
  .divider { width: 1px; height: 24px; background: #e2e8f0; }

  /* --- LANG SELECTOR --- */
  .lang-wrapper {
    display: flex; align-items: center; gap: 10px;
    background: #f1f5f9; padding: 6px 14px; border-radius: 20px;
    border: 1px solid transparent; transition: 0.3s;
  }
  .current-flag-icon { display: flex; align-items: center; border-radius: 2px; overflow: hidden; }
  .premium-lang-select { border: none; background: transparent; font-size: 0.85rem; font-weight: 700; cursor: pointer; outline: none; color: #1e293b; }

  /* --- BUTTONS --- */
  .github-btn { display: flex; align-items: center; gap: 8px; background: #0f172a; color: white; padding: 8px 16px; border-radius: 10px; text-decoration: none; font-weight: 600; transition: all 0.3s; }
  .github-btn:hover { background: #2563eb; transform: translateY(-2px); }

  .burger-btn {
    display: none; /* CACHÃ‰ SUR DESKTOP */
    flex-direction: column; justify-content: space-between;
    width: 26px; height: 18px; background: none; border: none; cursor: pointer; padding: 0;
  }
  .line { width: 100%; height: 3px; background-color: #0f172a; border-radius: 10px; }

  /* --- MOBILE SIDEBAR (CORRECTIF ICI) --- */
  .mobile-sidebar {
    position: fixed; 
    top: 0; 
    right: -100%; /* Sort complÃ¨tement de l'Ã©cran par dÃ©faut */
    width: 280px; 
    height: 100vh; 
    background: #ffffff;
    z-index: 1002; 
    padding: 2rem 1.5rem;
    box-shadow: -10px 0 30px rgba(0,0,0,0.1);
    transition: transform 0.4s ease, right 0.4s ease;
    display: none; /* NE PAS AFFICHER SUR DESKTOP */
    flex-direction: column;
  }

  /* Quand on clique sur le burger */
  .mobile-sidebar.is-active {
    display: flex;
    right: 0;
  }

  .menu-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
    background: rgba(15, 23, 42, 0.4); backdrop-filter: blur(4px);
    z-index: 1001; opacity: 0; visibility: hidden; transition: 0.3s;
  }
  .menu-overlay.is-active { opacity: 1; visibility: visible; }

  .sidebar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
  .sidebar-title { font-weight: 800; font-size: 1.2rem; color: #0f172a; }
  .close-sidebar { background: #f1f5f9; border: none; font-size: 1.8rem; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; color: #64748b; }
  .sidebar-nav { display: flex; flex-direction: column; gap: 1rem; }
  .sidebar-link { font-size: 1.1rem; font-weight: 600; color: #0f172a; text-decoration: none; padding: 0.8rem 0; border-bottom: 1px solid #f8fafc; }
  .sidebar-divider { height: 1px; background: #f1f5f9; margin: 1.5rem 0; }
  .sidebar-label { font-size: 0.75rem; text-transform: uppercase; color: #94a3b8; font-weight: 700; margin-bottom: 0.5rem; }

  /* --- RESPONSIVE LOGIC --- */
  @media (max-width: 992px) {
    .nav-menu-desktop, .desktop-only { display: none !important; }
    .burger-btn { display: flex; }
    .mobile-sidebar { display: flex; } /* On l'autorise Ã  exister mais elle est Ã  right: -100% */
    .github-text { display: none; }
    .github-btn { padding: 8px; }
  }

  /* Support RTL */
  :global([dir="rtl"]) .mobile-sidebar { right: auto; left: -100%; }
  :global([dir="rtl"]) .mobile-sidebar.is-active { left: 0; }
</style>

<script>
  const burger = document.getElementById('burger-trigger');
  const sidebar = document.getElementById('mobile-sidebar');
  const overlay = document.getElementById('menu-overlay');
  const closeBtn = document.getElementById('close-sidebar');

  const openSidebar = () => {
    if (sidebar && overlay) {
      sidebar.classList.add('is-active');
      overlay.classList.add('is-active');
      document.body.style.overflow = 'hidden';
    }
  };

  const closeSidebar = () => {
    if (sidebar && overlay) {
      sidebar.classList.remove('is-active');
      overlay.classList.remove('is-active');
      document.body.style.overflow = '';
    }
  };

  burger?.addEventListener('click', openSidebar);
  closeBtn?.addEventListener('click', closeSidebar);
  overlay?.addEventListener('click', closeSidebar);

  // Fermer si on clique sur un lien de la sidebar
  const sidebarLinks = document.querySelectorAll('.sidebar-link');
  sidebarLinks.forEach(link => link.addEventListener('click', closeSidebar));

  // SÃ©curitÃ© : Fermer la sidebar si on agrandit l'Ã©cran
  window.addEventListener('resize', () => {
    if (window.innerWidth > 992) {
      closeSidebar();
    }
  });
</script>